sudo: false
language: rust
matrix:
  fast_finish: true
  allow_failures:
    - name: rust beta
    - name: coverage
  include:
    - name: rust stable
      rust: stable

    - name: rust beta
      rust: beta

    - name: rust nightly
      rust: nightly
      script:
        - cargo test --release --features simd --no-run
        - strip target/release/hld
        - upx --ultra-brute --lzma target/release/hld
        - cargo test --release --features simd
        - mv target/release/hld target/release/hld-`target/release/hld --version | sed -e 's/hld //'`-`uname -m`
      addons:
        apt:
          packages:
            - upx

    - name: fmt
      rust: stable
      install:
        - rustup component add rustfmt-preview
      script:
        - cargo fmt -- --check

    - name: clippy
      rust: stable
      install:
        - rustup component add clippy-preview
      script:
        - cargo clippy -- -D clippy

    - name: coverage
      rust: stable
      install:
        - curl -L https://github.com/SimonKagstrom/kcov/archive/master.tar.gz | tar xvz
        - cd kcov-master && cmake . && make -j && sudo make install
      script:
        - echo $PATH
        - which kcov
        - cargo test --features kcov -- --test-threads 1
        - bash <(curl -s https://codecov.io/bash)
      addons: # required for kcov
        apt:
          packages:
            - libcurl4-openssl-dev
            - libelf-dev
            - libdw-dev
            - binutils-dev
            - cmake

script:
  - cargo test

# Need to cache the whole `.cargo` directory to keep .crates.toml for
# cargo-update to work - see https://levans.fr/rust_travis_cache.html
cache:
  directories:
    - /home/travis/.cargo
  apt: true
before_cache:
  # Travis can't cache files that are not readable by "others"
  - chmod -R a+r $HOME/.cargo
  # But don't cache the cargo registry
  - rm -rf /home/travis/.cargo/registry

notifications:
  email:
    on_success: never

deploy:
  provider: releases
  api_key:
    secure: XqSo1V1l0SxS7j3DKklFJAzpME5FHN6Xk4cMaxei2pwHotUEAc6REc23A4ghLh5VE/TbHiQ6NsT6VNi3hL4J3dJ5hz7vJ27YxVYbdYTEFR3lLhgOOOf/JM+ZzQ5cJRP3iEgPhQv1ohFpfYx1U/u6f03pDlji7Ju0PpmC4tFspg0JpuVywAArNN24UfUKKi/efRwyUZ/QXDhSi0xZG4Ld3xoK9pTXV4DDTtZY1wdcyw3DuxW2XG/MNz7+DpkjMDPRsSzhpVCwgijc4o+T0XidDIA1dIz0M5KCqn5Vt2c29VqmUZaMXOv0Nmj6OE8+OkDiBLgmR/lTxh4Zz3YXx8Y/wB98c23BHBNrdXD01G/VRuODXJTADpXa62RAMwxb8XaPVby4S5zGtl1y0fjMvChJ2xwGBCFn2oEmuOdq4+DjEyzDwvTsAgelHDUI23COuHpbn8nntLvrafMLOKjzR3klvmUVfNe7zAefe1R5JVzvcEijmDy+47urwe9N7qkV0bPBBqUg0d9QFpdgZMLDEDL8gkmTl87lJPE2J1z6XZiZv7Tjc6AN8FwcOMkxMVJSwAMKUUzH1B6LUtrb4gUJ0O/1AvDUgMGOjfjlh8/Thg2g0uTQwwAji6rJ09K9N7cthILxTcnHlf875OcpvDmJ6OAuSuq9q34u/GdM/Hn0LoYNvHU=
  file: target/release/hld-*-*
  skip_cleanup: true
  on:
    repo: glehmann/hld
    rust: nightly
    # tags: true
